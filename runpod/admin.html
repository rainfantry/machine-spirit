<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Machine Spirit - Admin Panel</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Courier New', monospace;
    background: #0a0a0a;
    color: #c0c0c0;
    min-height: 100vh;
  }
  .header {
    background: linear-gradient(135deg, #1a0000, #0d0d0d);
    border-bottom: 1px solid #8b0000;
    padding: 20px;
    text-align: center;
  }
  .header h1 {
    color: #ff4444;
    font-size: 1.5em;
    text-transform: uppercase;
    letter-spacing: 3px;
  }
  .header .subtitle {
    color: #666;
    font-size: 0.8em;
    margin-top: 5px;
  }
  .container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
  }
  .panel {
    background: #111;
    border: 1px solid #333;
    border-radius: 4px;
    margin-bottom: 20px;
    overflow: hidden;
  }
  .panel-header {
    background: #1a1a1a;
    padding: 12px 16px;
    border-bottom: 1px solid #333;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }
  .panel-header h2 {
    color: #ff6666;
    font-size: 1em;
    text-transform: uppercase;
    letter-spacing: 2px;
  }
  .panel-header .toggle { color: #666; }
  .panel-body { padding: 16px; }
  .panel-body.collapsed { display: none; }

  /* Form elements */
  label {
    display: block;
    color: #888;
    font-size: 0.8em;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 4px;
    margin-top: 12px;
  }
  label:first-child { margin-top: 0; }
  textarea {
    width: 100%;
    background: #0a0a0a;
    border: 1px solid #333;
    color: #ddd;
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
    padding: 10px;
    border-radius: 3px;
    resize: vertical;
    min-height: 200px;
    line-height: 1.5;
  }
  textarea:focus { border-color: #8b0000; outline: none; }
  select, input[type="text"], input[type="number"] {
    width: 100%;
    background: #0a0a0a;
    border: 1px solid #333;
    color: #ddd;
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
    padding: 8px 10px;
    border-radius: 3px;
  }
  select:focus, input:focus { border-color: #8b0000; outline: none; }
  .btn {
    background: #8b0000;
    color: #fff;
    border: none;
    padding: 10px 24px;
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    border-radius: 3px;
    margin-top: 12px;
  }
  .btn:hover { background: #aa0000; }
  .btn:disabled { background: #333; cursor: not-allowed; }
  .btn-secondary {
    background: #222;
    border: 1px solid #444;
  }
  .btn-secondary:hover { background: #333; }
  .btn-play {
    background: #1a3a1a;
    border: 1px solid #2a5a2a;
    padding: 6px 14px;
    font-size: 0.75em;
  }
  .btn-play:hover { background: #2a5a2a; }
  .btn-row {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
  }

  /* Voice card */
  .voice-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
  }
  .voice-card {
    background: #0a0a0a;
    border: 1px solid #333;
    border-radius: 3px;
    padding: 10px 12px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: border-color 0.2s;
  }
  .voice-card:hover { border-color: #666; }
  .voice-card.active { border-color: #8b0000; background: #1a0a0a; }
  .voice-card .voice-name { color: #ddd; font-size: 0.85em; }
  .voice-card .voice-desc { color: #666; font-size: 0.7em; margin-top: 2px; }
  .voice-card .voice-tags { display: flex; gap: 4px; flex-wrap: wrap; }
  .voice-tag {
    background: #1a1a1a;
    border: 1px solid #333;
    padding: 2px 6px;
    border-radius: 2px;
    font-size: 0.65em;
    color: #888;
  }

  /* Preset list */
  .preset-item {
    background: #0a0a0a;
    border: 1px solid #333;
    border-radius: 3px;
    padding: 10px 12px;
    margin-bottom: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .preset-item .preset-name { color: #ddd; font-size: 0.85em; }
  .preset-item .preset-base { color: #666; font-size: 0.7em; }
  .preset-item .preset-actions { display: flex; gap: 4px; }

  /* Status toast */
  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #1a3a1a;
    border: 1px solid #2a5a2a;
    color: #6f6;
    padding: 10px 16px;
    border-radius: 3px;
    font-size: 0.8em;
    display: none;
    z-index: 999;
  }
  .toast.error { background: #3a1a1a; border-color: #5a2a2a; color: #f66; }

  /* Audio preview */
  .audio-preview { margin-top: 8px; }
  audio { width: 100%; height: 32px; }

  .row { display: flex; gap: 12px; }
  .row > * { flex: 1; }

  @media (max-width: 600px) {
    .container { padding: 10px; }
    .row { flex-direction: column; }
  }
</style>
</head>
<body>

<div class="header">
  <h1>Machine Spirit</h1>
  <div class="subtitle">Admin Panel // Omnissiah Protocol</div>
</div>

<div class="container">

  <!-- PRESETS -->
  <div class="panel">
    <div class="panel-header" onclick="togglePanel(this)">
      <h2>Model Presets</h2>
      <span class="toggle">&#9660;</span>
    </div>
    <div class="panel-body" id="presets-body">
      <div id="preset-list">Loading...</div>
      <hr style="border-color:#222; margin:16px 0">
      <h3 style="color:#888; font-size:0.8em; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px">Create / Edit Preset</h3>
      <div class="row">
        <div>
          <label>Preset Name</label>
          <input type="text" id="preset-name" placeholder="Machine Spirit v2">
        </div>
        <div>
          <label>Base Model</label>
          <select id="preset-base">
            <option value="">Loading models...</option>
          </select>
        </div>
      </div>
      <label>System Prompt</label>
      <textarea id="preset-prompt" placeholder="You are the Machine Spirit of the Omnissiah..."></textarea>
      <div class="row">
        <div>
          <label>Temperature</label>
          <input type="number" id="preset-temp" value="0.8" min="0" max="2" step="0.1">
        </div>
        <div>
          <label>Top P</label>
          <input type="number" id="preset-topp" value="0.9" min="0" max="1" step="0.05">
        </div>
      </div>
      <input type="hidden" id="preset-edit-id" value="">
      <div class="btn-row">
        <button class="btn" onclick="savePreset()">Save Preset</button>
        <button class="btn btn-secondary" onclick="clearPresetForm()">Clear</button>
      </div>
    </div>
  </div>

  <!-- VOICE SELECTOR -->
  <div class="panel">
    <div class="panel-header" onclick="togglePanel(this)">
      <h2>Voice Selector</h2>
      <span class="toggle">&#9660;</span>
    </div>
    <div class="panel-body" id="voice-body">
      <div style="margin-bottom:12px">
        <label>Current Voice</label>
        <div id="current-voice" style="color:#ff6666; font-size:0.9em;">Loading...</div>
      </div>
      <label>Filter</label>
      <input type="text" id="voice-filter" placeholder="Search voices..." oninput="filterVoices()">
      <div id="voice-list" class="voice-grid" style="margin-top:12px">Loading...</div>
      <div class="audio-preview" id="audio-preview"></div>
    </div>
  </div>

  <!-- TTS SETTINGS -->
  <div class="panel">
    <div class="panel-header" onclick="togglePanel(this)">
      <h2>TTS Settings</h2>
      <span class="toggle">&#9660;</span>
    </div>
    <div class="panel-body" id="tts-body">
      <div class="row">
        <div>
          <label>TTS Engine</label>
          <select id="tts-engine">
            <option value="elevenlabs">ElevenLabs</option>
            <option value="openai">OpenAI</option>
          </select>
        </div>
        <div>
          <label>ElevenLabs Model</label>
          <select id="tts-model">
            <option value="eleven_turbo_v2_5">Turbo v2.5 (Fast)</option>
            <option value="eleven_flash_v2_5">Flash v2.5 (Faster)</option>
            <option value="eleven_multilingual_v2">Multilingual v2 (Quality)</option>
            <option value="eleven_monolingual_v1">Monolingual v1</option>
          </select>
        </div>
      </div>
      <label>Auto-Play Responses</label>
      <select id="tts-autoplay">
        <option value="true">Enabled</option>
        <option value="false">Disabled</option>
      </select>
      <div class="btn-row">
        <button class="btn" onclick="saveTTSSettings()">Save TTS Settings</button>
      </div>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
const API = window.location.origin.replace(/:\d+$/, '') + ':8188';
let TOKEN = '';
let VOICES = [];
let CURRENT_VOICE = '';

async function init() {
  // Auth
  const res = await fetch(`${API}/api/v1/auths/signin`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({email:'admin@local', password:'admin123'})
  });
  const data = await res.json();
  TOKEN = data.token;

  loadPresets();
  loadVoices();
  loadModels();
  loadTTSConfig();
}

function headers() {
  return { 'Authorization': `Bearer ${TOKEN}`, 'Content-Type': 'application/json' };
}

// PRESETS
async function loadPresets() {
  const res = await fetch(`${API}/api/v1/models`, { headers: headers() });
  const models = await res.json();
  const list = document.getElementById('preset-list');

  const presets = models.filter(m => m.base_model_id);
  if (!presets.length) {
    list.innerHTML = '<div style="color:#666">No presets yet</div>';
    return;
  }

  list.innerHTML = presets.map(m => `
    <div class="preset-item">
      <div>
        <div class="preset-name">${m.name}</div>
        <div class="preset-base">${m.base_model_id}</div>
      </div>
      <div class="preset-actions">
        <button class="btn btn-secondary" style="padding:4px 10px; font-size:0.7em" onclick="editPreset('${m.id}')">Edit</button>
        <button class="btn btn-secondary" style="padding:4px 10px; font-size:0.7em; color:#f66" onclick="deletePreset('${m.id}')">Del</button>
      </div>
    </div>
  `).join('');
}

async function loadModels() {
  const res = await fetch(`${API}/api/v1/models`, { headers: headers() });
  const models = await res.json();
  const sel = document.getElementById('preset-base');

  // Get ollama models
  let ollamaModels = [];
  try {
    const ores = await fetch(`${API}/ollama/api/tags`, { headers: headers() });
    const odata = await ores.json();
    ollamaModels = odata.models || [];
  } catch(e) {}

  sel.innerHTML = ollamaModels.map(m =>
    `<option value="${m.name}">${m.name} (${(m.size/1e9).toFixed(1)}GB)</option>`
  ).join('');
}

async function editPreset(id) {
  const res = await fetch(`${API}/api/v1/models/${encodeURIComponent(id)}`, { headers: headers() });
  const m = await res.json();

  document.getElementById('preset-edit-id').value = m.id;
  document.getElementById('preset-name').value = m.name;
  document.getElementById('preset-base').value = m.base_model_id;
  document.getElementById('preset-prompt').value = m.params?.system || '';
  document.getElementById('preset-temp').value = m.params?.temperature || 0.8;
  document.getElementById('preset-topp').value = m.params?.top_p || 0.9;

  toast('Loaded preset: ' + m.name);
}

async function savePreset() {
  const editId = document.getElementById('preset-edit-id').value;
  const name = document.getElementById('preset-name').value.trim();
  const base = document.getElementById('preset-base').value;
  const system = document.getElementById('preset-prompt').value;
  const temp = parseFloat(document.getElementById('preset-temp').value);
  const topp = parseFloat(document.getElementById('preset-topp').value);

  if (!name || !base) { toast('Name and base model required', true); return; }

  const id = editId || name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
  const payload = {
    id: id,
    name: name,
    base_model_id: base,
    meta: { profile_image_url: '', description: '', capabilities: { vision: false } },
    params: { system: system, temperature: temp, top_p: topp }
  };

  let res;
  if (editId) {
    res = await fetch(`${API}/api/v1/models/update`, {
      method: 'POST', headers: headers(), body: JSON.stringify(payload)
    });
  } else {
    res = await fetch(`${API}/api/v1/models/create`, {
      method: 'POST', headers: headers(), body: JSON.stringify(payload)
    });
  }

  if (res.ok) {
    toast('Preset saved: ' + name);
    clearPresetForm();
    loadPresets();
  } else {
    toast('Error saving preset', true);
  }
}

async function deletePreset(id) {
  if (!confirm('Delete preset ' + id + '?')) return;
  const res = await fetch(`${API}/api/v1/models/delete`, {
    method: 'DELETE', headers: headers(),
    body: JSON.stringify({ id: id })
  });
  if (res.ok) { toast('Deleted'); loadPresets(); }
}

function clearPresetForm() {
  document.getElementById('preset-edit-id').value = '';
  document.getElementById('preset-name').value = '';
  document.getElementById('preset-prompt').value = '';
  document.getElementById('preset-temp').value = '0.8';
  document.getElementById('preset-topp').value = '0.9';
}

// VOICES
async function loadVoices() {
  // Load current voice config
  const cfgRes = await fetch(`${API}/api/v1/audio/config`, { headers: headers() });
  const cfg = await cfgRes.json();
  CURRENT_VOICE = cfg.tts.VOICE;

  document.getElementById('tts-model').value = cfg.tts.MODEL || 'eleven_turbo_v2_5';

  // Fetch voices from ElevenLabs via our proxy
  try {
    const res = await fetch('https://api.elevenlabs.io/v1/voices', {
      headers: { 'xi-api-key': cfg.tts.API_KEY }
    });
    const data = await res.json();
    VOICES = data.voices || [];
  } catch(e) {
    // Fallback: use hardcoded list
    VOICES = [];
  }

  renderVoices();
}

function renderVoices() {
  const filter = (document.getElementById('voice-filter').value || '').toLowerCase();
  const filtered = VOICES.filter(v =>
    v.name.toLowerCase().includes(filter) ||
    (v.labels?.accent || '').toLowerCase().includes(filter) ||
    (v.labels?.descriptive || '').toLowerCase().includes(filter) ||
    (v.labels?.gender || '').toLowerCase().includes(filter)
  );

  const currentInfo = VOICES.find(v => v.voice_id === CURRENT_VOICE);
  document.getElementById('current-voice').textContent = currentInfo
    ? `${currentInfo.name} (${CURRENT_VOICE.substring(0,8)}...)`
    : CURRENT_VOICE;

  document.getElementById('voice-list').innerHTML = filtered.map(v => {
    const labels = v.labels || {};
    const tags = [labels.accent, labels.gender, labels.age, labels.descriptive].filter(Boolean);
    const active = v.voice_id === CURRENT_VOICE ? 'active' : '';
    return `
      <div class="voice-card ${active}" onclick="selectVoice('${v.voice_id}')">
        <div>
          <div class="voice-name">${v.name}</div>
          <div class="voice-desc">${v.voice_id.substring(0,12)}...</div>
        </div>
        <div style="display:flex; align-items:center; gap:8px">
          <div class="voice-tags">
            ${tags.map(t => `<span class="voice-tag">${t}</span>`).join('')}
          </div>
          <button class="btn btn-play" onclick="event.stopPropagation(); previewVoice('${v.voice_id}', '${v.name.replace(/'/g, "\\'")}')">&#9654;</button>
        </div>
      </div>`;
  }).join('');
}

function filterVoices() { renderVoices(); }

async function selectVoice(voiceId) {
  // Update server config
  const cfgRes = await fetch(`${API}/api/v1/audio/config`, { headers: headers() });
  const cfg = await cfgRes.json();
  cfg.tts.VOICE = voiceId;

  await fetch(`${API}/api/v1/audio/config/update`, {
    method: 'POST', headers: headers(), body: JSON.stringify(cfg)
  });

  // Update user settings
  await fetch(`${API}/api/v1/users/user/settings/update`, {
    method: 'POST', headers: headers(),
    body: JSON.stringify({
      ui: { version: '0.7.2' },
      audio: { tts: { autoPlayResponse: true, engine: 'elevenlabs', voice: voiceId, model: cfg.tts.MODEL, nonLocalVoices: true } }
    })
  });

  CURRENT_VOICE = voiceId;
  renderVoices();
  toast('Voice updated: ' + voiceId.substring(0,12));
}

async function previewVoice(voiceId, name) {
  const preview = document.getElementById('audio-preview');
  preview.innerHTML = '<div style="color:#666; font-size:0.8em">Generating preview...</div>';

  try {
    const cfgRes = await fetch(`${API}/api/v1/audio/config`, { headers: headers() });
    const cfg = await cfgRes.json();

    const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
      method: 'POST',
      headers: {
        'xi-api-key': cfg.tts.API_KEY,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        text: "The flesh is weak. The machine endures. I am the voice of the Omnissiah.",
        model_id: cfg.tts.MODEL,
        voice_settings: { stability: 0.35, similarity_boost: 0.6, style: 0.85 }
      })
    });

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    preview.innerHTML = `
      <div style="color:#888; font-size:0.75em; margin-bottom:4px">Preview: ${name}</div>
      <audio controls autoplay src="${url}"></audio>
    `;
  } catch(e) {
    preview.innerHTML = `<div style="color:#f66; font-size:0.8em">Preview failed: ${e.message}</div>`;
  }
}

// TTS SETTINGS
async function loadTTSConfig() {
  const cfgRes = await fetch(`${API}/api/v1/audio/config`, { headers: headers() });
  const cfg = await cfgRes.json();
  document.getElementById('tts-engine').value = cfg.tts.ENGINE || 'elevenlabs';
  document.getElementById('tts-model').value = cfg.tts.MODEL || 'eleven_turbo_v2_5';

  const settingsRes = await fetch(`${API}/api/v1/users/user/settings`, { headers: headers() });
  const settings = await settingsRes.json();
  document.getElementById('tts-autoplay').value = settings.audio?.tts?.autoPlayResponse ? 'true' : 'false';
}

async function saveTTSSettings() {
  const engine = document.getElementById('tts-engine').value;
  const model = document.getElementById('tts-model').value;
  const autoplay = document.getElementById('tts-autoplay').value === 'true';

  // Update server config
  const cfgRes = await fetch(`${API}/api/v1/audio/config`, { headers: headers() });
  const cfg = await cfgRes.json();
  cfg.tts.ENGINE = engine;
  cfg.tts.MODEL = model;

  await fetch(`${API}/api/v1/audio/config/update`, {
    method: 'POST', headers: headers(), body: JSON.stringify(cfg)
  });

  // Update user settings
  await fetch(`${API}/api/v1/users/user/settings/update`, {
    method: 'POST', headers: headers(),
    body: JSON.stringify({
      ui: { version: '0.7.2' },
      audio: { tts: { autoPlayResponse: autoplay, engine: engine, voice: CURRENT_VOICE, model: model, nonLocalVoices: true } }
    })
  });

  toast('TTS settings saved');
}

// UI helpers
function togglePanel(header) {
  const body = header.nextElementSibling;
  body.classList.toggle('collapsed');
  header.querySelector('.toggle').textContent = body.classList.contains('collapsed') ? '\u25B6' : '\u25BC';
}

function toast(msg, isError) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast' + (isError ? ' error' : '');
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 3000);
}

init();
</script>
</body>
</html>
